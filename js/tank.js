// Generated by CoffeeScript 1.6.1
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

(function(window, $) {
  'use strict';
  var Base, BulletModel, BulletView, CLASSES, DEBUG, DEFAULT_ANGLE_SPEED, DEFAULT_ANGLE_UPDATE_DELAY, DEFAULT_BULLET_EXPLODE_TIME, DEFAULT_BULLET_HEIGHT, DEFAULT_BULLET_LENGTH, DEFAULT_BULLET_SPEED, DEFAULT_BULLET_WIDTH, DEFAULT_SPEED, DEFAULT_TANK_HEIGHT, DEFAULT_TANK_WIDTH, DOM_CONTAINER, Observer, Tank, TankModel, TankView, View, requestAnimFrame;
  DEFAULT_SPEED = 5;
  DEFAULT_ANGLE_SPEED = 2;
  DEFAULT_BULLET_SPEED = 300;
  DEFAULT_BULLET_LENGTH = 300;
  DEFAULT_TANK_WIDTH = 75;
  DEFAULT_TANK_HEIGHT = 150;
  DEFAULT_BULLET_WIDTH = 16;
  DEFAULT_BULLET_HEIGHT = 16;
  DEFAULT_BULLET_EXPLODE_TIME = 500;
  DEFAULT_ANGLE_UPDATE_DELAY = 100;
  DEBUG = true;
  DOM_CONTAINER = null;
  CLASSES = {
    tank: {
      main: 'b-tank'
    },
    bullet: {
      main: 'b-bullet'
    }
  };
  /*
  	# function loop for animations
  */

  requestAnimFrame = (function() {
    return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(callback, element) {
      return window.setTimeout(callback, 1000 / 60);
    };
  })();
  
	if (!Function.prototype.bind) {
	  Function.prototype.bind = function (oThis) {
	    if (typeof this !== "function") {
	      // closest thing possible to the ECMAScript 5 internal IsCallable function
	      throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");
	    }
	 
	    var aArgs = Array.prototype.slice.call(arguments, 1), 
	        fToBind = this, 
	        fNOP = function () {},
	        fBound = function () {
	          return fToBind.apply(this instanceof fNOP && oThis
	                                 ? this
	                                 : oThis,
	                               aArgs.concat(Array.prototype.slice.call(arguments)));
	        };
	 
	    fNOP.prototype = this.prototype;
	    fBound.prototype = new fNOP();
	 
	    return fBound;
	  };
	}
    ;
  /*
  	# Base class for all tank classes
  */

  Base = (function() {

    function Base() {}

    /*
    		# flag of enable debug
    		# @var {boolean}
    */


    Base.debug = DEBUG;

    /*
    		# log message in console
    		# @param {string} message
    */


    Base.prototype.log = function(message) {
      if (this.constructor.debug && window.console && window.console.log) {
        return window.console.log(message);
      }
    };

    /*
    		# log error message in console
    		# @param {string} message
    */


    Base.prototype.error = function(message) {
      if (this.constructor.debug && window.console && window.console.log) {
        return window.console.error(message);
      }
    };

    return Base;

  })();
  /*
  	# Pattern observer for event model
  */

  Observer = (function(_super) {

    __extends(Observer, _super);

    /*
    		# @constructor
    */


    function Observer() {
      Observer.__super__.constructor.apply(this, arguments);
      this._subscribers = {};
    }

    /*
    		# subscribe
    		# @param {string} id event identifier
    		# @param {function} callback
    */


    Observer.prototype.on = function(id, callback) {
      id = $.trim(id);
      if (id.length === 0) {
        this.error('incorrect id in Observer.on');
        this;
      }
      if (!$.isFunction(callback)) {
        this.error('incorrect callback in Observer.on');
        this;
      }
      if (this._subscribers[id]) {
        this._subscribers[id].push(callback);
      } else {
        this._subscribers[id] = [callback];
      }
      return this;
    };

    /*
    		# unsubscribe
    		# @param {string} id event identifier
    		# @param {function} callback
    */


    Observer.prototype.off = function(id, callback) {
      var handler, handlers, key, _i, _len;
      id = $.trim(id);
      if (id.length === 0) {
        this.error('incorrect id in Observer.off');
        this;
      }
      if (!$.isFunction(callback)) {
        this._subscribers[id] = [];
      } else {
        handlers = this._subscribers[id];
        for (key = _i = 0, _len = handlers.length; _i < _len; key = ++_i) {
          handler = handlers[key];
          console.log(handler);
          if (handler === callback) {
            handlers[key] = null;
          }
        }
      }
      return this;
    };

    /*
    		# call subscribed callbacks
    		# @param {string} id event identifier
    */


    Observer.prototype.publish = function(id) {
      var args, handler, handlers, key;
      id = $.trim(id);
      if (id.length === 0) {
        this.error('incorrect id in Observer.publish');
      }
      handlers = this._subscribers[id];
      args = Array.prototype.slice.call(arguments, 1);
      for (key in handlers) {
        handler = handlers[key];
        if (handler != null) {
          handler.apply(this, args);
        }
      }
      return this;
    };

    return Observer;

  })(Base);
  /*
  	# Model of tank
  */

  TankModel = (function(_super) {

    __extends(TankModel, _super);

    /*
    		# @constructor
    */


    function TankModel() {
      TankModel.__super__.constructor.apply(this, arguments);
      /*
      			# Current directrion
      			# @var {string}
      */

      this._directrion = null;
      /*
      			# Speed of tank in pixel per iteration
      			# @var {number}
      */

      this._speed = DEFAULT_SPEED;
      /*
      			# Angle speed of tank in degrees per iteration
      			# @var {number}
      */

      this._angleSpeed = DEFAULT_ANGLE_SPEED;
      /*
      			# width
      			# @var {number}
      */

      this.width = DEFAULT_TANK_WIDTH;
      /*
      			# height
      			# @var {number}
      */

      this.height = DEFAULT_TANK_HEIGHT;
      /*
      			# angle tank rotate
      			# @var {number}
      */

      this._angle = 0;
      /*
      			# delay of skip rotate
      			# @var {number}
      */

      this._angleUpdateDelay = DEFAULT_ANGLE_UPDATE_DELAY;
    }

    /*
    		# Set direction of tank
    		# @param {string} direction
    */


    TankModel.prototype.rotate = function(direction) {
      if (direction === 'left') {
        this._angle -= this._angleSpeed;
      } else if (direction === 'right') {
        this._angle += this._angleSpeed;
      }
      return this.publish('angleChange', this._angle);
    };

    /*
    		# Set speed of tank
    		# @param {number} speed on pixels per iteration
    */


    TankModel.prototype.setSpeed = function(speed) {
      if (!$.isNumeric(speed)) {
        this.error('incorrect speed in TankModel.setSpeed');
        this;
      }
      return this._speed = speed;
    };

    /*
    		# return speed of tank
    		# return {number}
    */


    TankModel.prototype.getSpeed = function() {
      return this._speed;
    };

    /*
    		# return angle tank rotate
    		# @return {number}
    */


    TankModel.prototype.getAngle = function() {
      return (this._angle + 90) * Math.PI / 180;
    };

    /*
    		# update angle rotate
    */


    TankModel.prototype._updateAngle = function() {
      /*
      			if @_directrion == 'left'
      				@_angle -= 90
      			if @_directrion == 'right'
      				@_angle += 90
      			@publish 'angleChange', @_angle
      */

    };

    return TankModel;

  })(Observer);
  /*
  	# class of view
  */

  View = (function(_super) {

    __extends(View, _super);

    /*
    		# @constructor
    */


    function View() {
      View.__super__.constructor.apply(this, arguments);
      this._$domContainer = DOM_CONTAINER;
    }

    return View;

  })(Observer);
  /*
  	# model of bullet
  */

  BulletModel = (function(_super) {

    __extends(BulletModel, _super);

    function BulletModel() {
      BulletModel.__super__.constructor.apply(this, arguments);
      this._speed = DEFAULT_BULLET_SPEED;
      this._length = DEFAULT_BULLET_LENGTH;
      this.width = DEFAULT_BULLET_WIDTH;
      this.height = DEFAULT_BULLET_HEIGHT;
    }

    /*
    		# return speed of bullet
    		# @return {number}
    */


    BulletModel.prototype.getSpeed = function() {
      return this._speed;
    };

    /*
    		# return length of bullet
    		# return {number}
    */


    BulletModel.prototype.getLength = function() {
      return this._length;
    };

    return BulletModel;

  })(Observer);
  /*
  	# View of bullet
  */

  BulletView = (function(_super) {

    __extends(BulletView, _super);

    /*
    		# @constructor
    		# @param {number} coord.left X coordinate of tank
    		# @param {number} coord.top Y coordinate of tank
    		# @param {BulletModel} model model of ballet
    		# @param {TankModel} tankModel model of tank
    */


    function BulletView(coord, model, tankModel) {
      BulletView.__super__.constructor.apply(this, arguments);
      this.model = model;
      this.tankModel = tankModel;
      this._explodeTime = DEFAULT_BULLET_EXPLODE_TIME;
      this.$bullet = $("<div class='" + CLASSES.bullet.main + "'></div>").appendTo(this._$domContainer);
      this.setCoord(coord);
      this.move(this.tankModel.getAngle());
    }

    /*
    		# set start coordinate
    		# @param {number} coord.left X coordinate of tank
    		# @param {number} coord.top Y coordinate of tank
    		# @param {string} direction current tank direction
    */


    BulletView.prototype.setCoord = function(coord, direction) {
      var angle, height, width;
      angle = this.tankModel.getAngle();
      width = this.tankModel.width;
      height = this.tankModel.height;
      this.position = {
        left: coord.left + (width / 2) + (height / 2) * Math.cos(angle + Math.PI),
        top: coord.top + (height / 2) * Math.sin(angle + Math.PI)
      };
      return this.$bullet.css(this.position);
    };

    /*
    		# move bullet
    		# @param {number} angle
    */


    BulletView.prototype.move = function(angle) {
      var length,
        _this = this;
      length = this.model.getLength();
      this.position = {
        left: this.position.left + length * Math.cos(angle + Math.PI),
        top: this.position.top + length * Math.sin(angle + Math.PI)
      };
      return this.$bullet.animate(this.position, this.model.getSpeed(), 'linear', function() {
        _this.$bullet.addClass('explode');
        return setTimeout(function() {
          return _this.$bullet.remove();
        }, 500);
      });
    };

    /*
    		# explode
    */


    BulletView.prototype.explode = function() {
      var _this = this;
      this.$bullet.addClass('explode');
      return setTimeout(function() {
        return _this.$bullet.remove();
      }, this._explodeTime);
    };

    return BulletView;

  })(View);
  /*
  	# View of tank
  */

  TankView = (function(_super) {

    __extends(TankView, _super);

    TankView.prototype.keyMap = {
      left: 37,
      right: 39,
      top: 38,
      bottom: 40,
      space: 32
    };

    /*
    		# @constructor
    		# @param {TankModel} model of tank
    */


    function TankView(model) {
      TankView.__super__.constructor.apply(this, arguments);
      if (!model || !(model instanceof TankModel)) {
        this.error('incorrect model in TankView.constructor');
        this;
      }
      this.model = model;
      this.$tank = $("<div class='" + CLASSES.tank.main + "'></div>").appendTo(this._$domContainer);
      this.$tank.css(this.$tank.position());
      this.position = this.$tank.position();
      this._pressed = {};
      this._bindEvents();
      this.update();
    }

    /*
    		# move tank
    		# @param {string} directionX
    */


    TankView.prototype.move = function(direction) {
      var angle, sign, speed;
      speed = this.model.getSpeed();
      angle = this.model.getAngle();
      if (direction === 'forward') {
        sign = -1;
      }
      if (direction === 'back') {
        sign = 1;
      }
      this.position = {
        left: this.position.left + sign * speed * Math.cos(angle),
        top: this.position.top + sign * speed * Math.sin(angle)
      };
      return this.$tank.css(this.position);
    };

    /*
    		# shot (create bullet)
    */


    TankView.prototype.shot = function() {
      var bulletModel, bulletView;
      bulletModel = new BulletModel;
      return bulletView = new BulletView({
        left: parseInt(this.$tank.css('left')),
        top: parseInt(this.$tank.css('top'))
      }, bulletModel, this.model);
    };

    /*
    		# rotate tank
    		# @param {number} angle
    */


    TankView.prototype.rotate = function(angle) {
      var cos, sin;
      if (!$.browser.msie) {
        return this.$tank.css({
          '-webkit-transform': "rotate(" + angle + "deg)",
          '-moz-transform': "rotate(" + angle + "deg)",
          '-o-transform': "rotate(" + angle + "deg)",
          '-ms-transform': "rotate(" + angle + "deg)",
          'transform': "rotate(" + angle + "deg)"
        });
      } else {
        cos = Math.cos(angle);
        sin = Math.sin(angle);
        return this.$tank.css({
          filter: 'progid:DXImageTransform.Microsoft.Matrix(sizingMethod="auto expand", M11 = ' + cos + ', M12 = ' + (-sin) + ', M21 = ' + sin + ', M22 = ' + cos + ')',
          '-ms-filter': 'progid:DXImageTransform.Microsoft.Matrix(sizingMethod="auto expand", M11 = ' + cos + ', M12 = ' + (-sin) + ', M21 = ' + sin + ', M22 = ' + cos + ')'
        });
      }
    };

    /*
    		# update view
    */


    TankView.prototype.update = function() {
      var keyCode, value, _ref;
      _ref = this._pressed;
      for (keyCode in _ref) {
        value = _ref[keyCode];
        switch (Number(keyCode)) {
          case this.keyMap.left:
            this.publish('leftKeyDown');
            break;
          case this.keyMap.right:
            this.publish('rightKeyDown');
            break;
          case this.keyMap.top:
            this.move('forward');
            this.publish('topKeyDown');
            break;
          case this.keyMap.bottom:
            this.move('back');
            this.publish('bottomKeyDown');
            break;
          case this.keyMap.space:
            this.shot();
            delete this._pressed[this.keyMap.space];
        }
      }
      return requestAnimFrame(this.update.bind(this), this.$tank);
    };

    /*
    		# bind dom events
    */


    TankView.prototype._bindEvents = function() {
      var _this = this;
      this._$domContainer.on('keydown', function(event) {
        _this._onKeyDown(event);
        return event.preventDefault();
      });
      return this._$domContainer.on('keyup', function(event) {
        _this._onKeyUp(event);
        return event.preventDefault();
      });
    };

    /*
    		# key down handler
    		# @param {jQuery.Event} event jquery event object
    */


    TankView.prototype._onKeyDown = function(event) {
      return this._pressed[event.keyCode] = true;
    };

    /*
    		# key up handler
    		# @param {jQuery.Event} event jquery event object
    */


    TankView.prototype._onKeyUp = function(event) {
      return delete this._pressed[event.keyCode];
    };

    return TankView;

  })(View);
  /*
  	# class of tank
  */

  Tank = (function(_super) {

    __extends(Tank, _super);

    /*
    		# @constructor
    */


    function Tank() {
      Tank.__super__.constructor.apply(this, arguments);
      this.model = new TankModel();
      this.view = new TankView(this.model);
      this._bindEvents();
    }

    /*
    		# subscribe on view and model events
    */


    Tank.prototype._bindEvents = function() {
      var _this = this;
      this.view.on('leftKeyDown', function(event) {
        return _this.model.rotate('left');
      });
      this.view.on('rightKeyDown', function(event) {
        return _this.model.rotate('right');
      });
      return this.model.on('angleChange', function(angle) {
        return _this.view.rotate(angle);
      });
    };

    return Tank;

  })(Observer);
  return $(function() {
    DOM_CONTAINER = $(document.body);
    return new Tank();
  });
})(window, jQuery);
