// Generated by CoffeeScript 1.6.1
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

(function(window, $) {
  'use strict';
  var Base, BulletModel, BulletView, CLASSES, DEAFAULT_BULLET_LENGTH, DEAFAULT_BULLET_SPEED, DEAFAULT_SPEED, DEBUG, DEFAULT_BULLET_HEIGHT, DEFAULT_BULLET_WIDTH, DEFAULT_TANK_HEIGHT, DEFAULT_TANK_WIDTH, DOM_CONTAINER, Observer, Tank, TankModel, TankView, View;
  DEAFAULT_SPEED = 20;
  DEAFAULT_BULLET_SPEED = 300;
  DEAFAULT_BULLET_LENGTH = 400;
  DEFAULT_TANK_WIDTH = 75;
  DEFAULT_TANK_HEIGHT = 150;
  DEFAULT_BULLET_WIDTH = 16;
  DEFAULT_BULLET_HEIGHT = 16;
  DEBUG = true;
  DOM_CONTAINER = null;
  CLASSES = {
    tank: {
      main: 'b-tank'
    },
    bullet: {
      main: 'b-bullet'
    }
  };
  /*
  	# Base class for all tank classes
  */

  Base = (function() {

    function Base() {}

    /*
    		# flag of enable debug
    		# @var {boolean}
    */


    Base.debug = DEBUG;

    /*
    		# log message in console
    		# @param {string} message
    */


    Base.prototype.log = function(message) {
      if (this.constructor.debug && window.console && window.console.log) {
        return window.console.log(message);
      }
    };

    /*
    		# log error message in console
    		# @param {string} message
    */


    Base.prototype.error = function(message) {
      if (this.constructor.debug && window.console && window.console.log) {
        return window.console.error(message);
      }
    };

    return Base;

  })();
  /*
  	# Pattern observer for event model
  */

  Observer = (function(_super) {

    __extends(Observer, _super);

    /*
    		# @constructor
    */


    function Observer() {
      Observer.__super__.constructor.apply(this, arguments);
      this._subscribers = {};
    }

    /*
    		# subscribe
    		# @param {string} id event identifier
    		# @param {function} callback
    */


    Observer.prototype.on = function(id, callback) {
      id = $.trim(id);
      if (id.length === 0) {
        this.error('incorrect id in Observer.on');
        this;
      }
      if (!$.isFunction(callback)) {
        this.error('incorrect callback in Observer.on');
        this;
      }
      if (this._subscribers[id]) {
        this._subscribers[id].push(callback);
      } else {
        this._subscribers[id] = [callback];
      }
      return this;
    };

    Observer.prototype.off = function(id, callback) {
      var handler, handlers, key, _i, _len;
      id = $.trim(id);
      if (id.length === 0) {
        this.error('incorrect id in Observer.off');
        this;
      }
      if (!$.isFunction(callback)) {
        this._subscribers[id] = [];
      } else {
        handlers = this._subscribers[id];
        for (key = _i = 0, _len = handlers.length; _i < _len; key = ++_i) {
          handler = handlers[key];
          console.log(handler);
          if (handler === callback) {
            handlers[key] = null;
          }
        }
      }
      return this;
    };

    /*
    		# call subscribed callbacks
    		# @param {string} id event identifier
    */


    Observer.prototype.publish = function(id) {
      var args, handler, handlers, _i, _len;
      id = $.trim(id);
      if (id.length === 0) {
        this.error('incorrect id in Observer.publish');
      }
      handlers = this._subscribers[id];
      args = Array.prototype.slice.call(arguments, 1);
      for (_i = 0, _len = handlers.length; _i < _len; _i++) {
        handler = handlers[_i];
        if (handler != null) {
          handler.apply(this, args);
        }
      }
      return this;
    };

    return Observer;

  })(Base);
  /*
  	# Model of tank
  */

  TankModel = (function(_super) {

    __extends(TankModel, _super);

    /*
    		# available values of property direction
    		# @param {array}
    */


    TankModel.prototype.availableDirections = ['top', 'right', 'bottom', 'left'];

    /*
    		# @constructor
    */


    function TankModel() {
      TankModel.__super__.constructor.apply(this, arguments);
      /*
      			# Current directrion
      			# @var {string}
      */

      this._directrion = 'top';
      /*
      			# Speed of tank in pixel per iteration
      			# @var {number}
      */

      this._speed = DEAFAULT_SPEED;
      /*
      			# width
      			# @var {number}
      */

      this.width = DEFAULT_TANK_WIDTH;
      /*
      			# height
      			# @var {number}
      */

      this.height = DEFAULT_TANK_HEIGHT;
    }

    /*
    		# Set direction of tank
    		# @param {string} direction
    */


    TankModel.prototype.setDirection = function(direction) {
      if (this.availableDirections.indexOf(direction) !== -1) {
        this._directrion = direction;
        return this.publish('changeDirection', direction);
      } else {
        return this.error("unsupport direction " + direction);
      }
    };

    /*
    		# return direction of tank
    		# @return {string}
    */


    TankModel.prototype.getDirection = function() {
      return this._directrion;
    };

    /*
    		# Set speed of tank
    		# @param {number} speed on pixels per iteration
    */


    TankModel.prototype.setSpeed = function(speed) {
      if (!$.isNumeric(speed)) {
        this.error('incorrect speed in TankModel.setSpeed');
        this;
      }
      return this._speed = speed;
    };

    /*
    		# return speed of tank
    		# return {number}
    */


    TankModel.prototype.getSpeed = function() {
      return this._speed;
    };

    return TankModel;

  })(Observer);
  /*
  	# class of view
  */

  View = (function(_super) {

    __extends(View, _super);

    /*
    		# @constructor
    */


    function View() {
      View.__super__.constructor.apply(this, arguments);
      this._$domContainer = DOM_CONTAINER;
    }

    return View;

  })(Observer);
  BulletModel = (function(_super) {

    __extends(BulletModel, _super);

    function BulletModel() {
      BulletModel.__super__.constructor.apply(this, arguments);
      this._speed = DEAFAULT_BULLET_SPEED;
      this._length = DEAFAULT_BULLET_LENGTH;
      this.width = DEFAULT_BULLET_WIDTH;
      this.height = DEFAULT_BULLET_HEIGHT;
    }

    BulletModel.prototype.getSpeed = function() {
      return this._speed;
    };

    BulletModel.prototype.getLength = function() {
      return this._length;
    };

    return BulletModel;

  })(Observer);
  /*
  	# View of bullet
  */

  BulletView = (function(_super) {

    __extends(BulletView, _super);

    /*
    		# @constructor
    */


    function BulletView(coord, model, tankModel) {
      BulletView.__super__.constructor.apply(this, arguments);
      this.model = model;
      this.tankModel = tankModel;
      this.$bullet = $("<div class='" + CLASSES.bullet.main + "'></div>").appendTo(this._$domContainer);
      this.setCoord(coord, this.tankModel.getDirection());
      this.move(this.tankModel.getDirection());
    }

    BulletView.prototype.setCoord = function(coord, direction) {
      switch (direction) {
        case 'left':
          coord.top -= this.tankModel.width / 2 + this.model.height / 2;
          break;
        case 'right':
          coord.top -= this.tankModel.width / 2 + this.model.height / 2;
          coord.left += this.tankModel.height;
          break;
        case 'top':
          coord.left += this.tankModel.width / 2 - this.model.width / 2;
          coord.top -= this.tankModel.height / 2;
          break;
        case 'bottom':
          coord.left += this.tankModel.width / 2 - this.model.width / 2;
          coord.top += this.tankModel.height / 2 - this.model.height / 2;
      }
      return this.$bullet.css(coord);
    };

    BulletView.prototype.move = function(direction) {
      switch (direction) {
        case 'left':
          return this.$bullet.animate({
            left: "-=" + (this.model.getLength())
          }, this.model.getSpeed(), 'linear', this.explode.bind(this));
        case 'right':
          return this.$bullet.animate({
            left: "+=" + (this.model.getLength())
          }, this.model.getSpeed(), 'linear', this.explode.bind(this));
        case 'top':
          return this.$bullet.animate({
            top: "-=" + (this.model.getLength())
          }, this.model.getSpeed(), 'linear', this.explode.bind(this));
        case 'bottom':
          return this.$bullet.animate({
            top: "+=" + (this.model.getLength())
          }, this.model.getSpeed(), 'linear', this.explode.bind(this));
      }
    };

    BulletView.prototype.explode = function() {
      var _this = this;
      this.$bullet.addClass('explode');
      return setTimeout(function() {
        return _this.$bullet.remove();
      }, 500);
    };

    return BulletView;

  })(View);
  /*
  	# View of tank
  */

  TankView = (function(_super) {

    __extends(TankView, _super);

    TankView.prototype.keyMap = {
      left: 37,
      right: 39,
      top: 38,
      bottom: 40,
      space: 32
    };

    /*
    		# @constructor
    		# @param {TankModel} model of tank
    */


    function TankView(model) {
      TankView.__super__.constructor.apply(this, arguments);
      if (!model || !(model instanceof TankModel)) {
        this.error('incorrect model in TankView.constructor');
        this;
      }
      this.model = model;
      this.$tank = $("<div class='" + CLASSES.tank.main + "'></div>").appendTo(this._$domContainer);
      this.$tank.css(this.$tank.position());
      this._bindEvents();
    }

    /*
    		# set direction of tank
    		# @param {string} direction
    */


    TankView.prototype.setDirection = function(direction) {
      var angle;
      switch (direction) {
        case 'left':
          angle = -90;
          break;
        case 'top':
          angle = 0;
          break;
        case 'right':
          angle = 90;
          break;
        case 'bottom':
          angle = 180;
      }
      return this.$tank.css({
        '-webkit-transform': "rotate(" + angle + "deg)"
      });
    };

    /*
    		# move tank
    		# @param {string} direction
    */


    TankView.prototype.move = function(direction) {
      var speed;
      speed = this.model.getSpeed();
      switch (direction) {
        case 'left':
          return this.$tank.css({
            left: parseInt(this.$tank.css('left')) - speed
          });
        case 'right':
          return this.$tank.css({
            left: parseInt(this.$tank.css('left')) + speed
          });
        case 'top':
          return this.$tank.css({
            top: parseInt(this.$tank.css('top')) - speed
          });
        case 'bottom':
          return this.$tank.css({
            top: parseInt(this.$tank.css('top')) + speed
          });
      }
    };

    TankView.prototype.shot = function() {
      var bulletModel, bulletView;
      bulletModel = new BulletModel;
      return bulletView = new BulletView(this.$tank.position(), bulletModel, this.model);
    };

    /*
    		# bind dom events
    */


    TankView.prototype._bindEvents = function() {
      var _this = this;
      return this._$domContainer.on('keydown', function(event) {
        _this._onKeyDown(event);
        return event.preventDefault();
      });
    };

    /*
    		# key down handler
    		# @param {jQuery.Event} event jquery event object
    */


    TankView.prototype._onKeyDown = function(event) {
      switch (event.keyCode) {
        case this.keyMap.left:
          this.move('left');
          return this.publish('leftKeyDown', event);
        case this.keyMap.right:
          this.move('right');
          return this.publish('rightKeyDown', event);
        case this.keyMap.top:
          this.move('top');
          return this.publish('topKeyDown', event);
        case this.keyMap.bottom:
          this.move('bottom');
          return this.publish('bottomKeyDown', event);
        case this.keyMap.space:
          return this.shot();
      }
    };

    return TankView;

  })(View);
  /*
  	# class of tank
  */

  Tank = (function(_super) {

    __extends(Tank, _super);

    /*
    		# @constructor
    */


    function Tank() {
      this.model = new TankModel();
      this.view = new TankView(this.model);
      this._bindEvents();
    }

    /*
    		# subscribe on view and model events
    */


    Tank.prototype._bindEvents = function() {
      var _this = this;
      this.view.on('leftKeyDown', function(event) {
        return _this.model.setDirection('left');
      });
      this.view.on('rightKeyDown', function(event) {
        return _this.model.setDirection('right');
      });
      this.view.on('topKeyDown', function(event) {
        return _this.model.setDirection('top');
      });
      this.view.on('bottomKeyDown', function(event) {
        return _this.model.setDirection('bottom');
      });
      return this.model.on('changeDirection', function(direction) {
        return _this.view.setDirection(direction);
      });
    };

    return Tank;

  })(Observer);
  return $(function() {
    DOM_CONTAINER = $(document.body);
    return new Tank();
  });
})(window, jQuery);
